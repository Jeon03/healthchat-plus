package com.healthchat.backend.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.healthchat.backend.config.GeminiClient;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.Map;

/**
 * âœ¨ ë¼ìš°íŒ… ì „ìš© ì„œë¹„ìŠ¤
 * ì‚¬ìš©ì ë¬¸ì¥ì„ â†’ ì‹ë‹¨/ìš´ë™/ê°ì •ë³„ë¡œ ë¶„ë¦¬í•˜ëŠ” ì—­í• 
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class GeminiRoutingService {

    private final GeminiClient geminiClient;
    private final ObjectMapper mapper = new ObjectMapper();


    // --------------------------------------------
    // ğŸ“Œ Routing ê²°ê³¼ DTO
    // --------------------------------------------
    public static record RoutingResult(
            String mealText,
            String exerciseText,
            String emotionText
    ) {}


    // ======================================================================
    // ğŸ”¥ ë©”ì¸ ë¼ìš°íŒ…
    // ======================================================================
    public RoutingResult route(String userText) {

        // -------------------------------------------------------
        // 1) ì „ì²´ ì‚­ì œ ëª…ë ¹ â†’ AI í˜¸ì¶œ ì•ˆ í•¨
        // -------------------------------------------------------
        if (isDeleteAllCommand(userText)) {
            log.info("ğŸ§¹ [Routing] ì „ì²´ ì‚­ì œ ëª…ë ¹ ê°ì§€ â†’ Gemini í˜¸ì¶œ ìƒëµ");

            return new RoutingResult(
                    "DELETE_ALL",
                    "DELETE_ALL",
                    "DELETE_ALL"
            );
        }

        // -------------------------------------------------------
        // 2) ê°œë³„ ì‚­ì œ ëª…ë ¹(ì‹ë‹¨/ìš´ë™/ê°ì •)
        // -------------------------------------------------------
        if (isDeleteMealCommand(userText)) {
            log.info("ğŸ± [Routing] ì‹ë‹¨ ì‚­ì œ ëª…ë ¹ ê°ì§€");
            return new RoutingResult("DELETE_MEAL", "", "");
        }

        if (isDeleteExerciseCommand(userText)) {
            log.info("ğŸ‹ [Routing] ìš´ë™ ì‚­ì œ ëª…ë ¹ ê°ì§€");
            return new RoutingResult("", "DELETE_EXERCISE", "");
        }

        if (isDeleteEmotionCommand(userText)) {
            log.info("ğŸ’¬ [Routing] ê°ì • ì‚­ì œ ëª…ë ¹ ê°ì§€");
            return new RoutingResult("", "", "DELETE_EMOTION");
        }


        // -------------------------------------------------------
        // 3) í”„ë¡¬í”„íŠ¸ ìƒì„±
        // -------------------------------------------------------
        String prompt = buildPrompt(userText);

        // -------------------------------------------------------
        // 4) pro â†’ flash fallback ìë™ ì ìš©
        // -------------------------------------------------------
        String response = geminiClient.generateSmartJson(prompt);

        if (response == null || response.isBlank()) {
            log.warn("âš ï¸ Routing ì‘ë‹µ null/ê³µë°± â€” fallback ë°˜í™˜");
            return new RoutingResult("", "", "");
        }

        // -------------------------------------------------------
        // 5) JSONë§Œ ì¶”ì¶œ
        // -------------------------------------------------------
        String json = extractJson(response);


        // -------------------------------------------------------
        // 6) JSON â†’ map íŒŒì‹±
        // -------------------------------------------------------
        try {
            Map<String, Object> map = mapper.readValue(json, Map.class);

            String meal = map.getOrDefault("mealText", "").toString();
            String exercise = map.getOrDefault("exerciseText", "").toString();
            String emotion = map.getOrDefault("emotionText", "").toString();

            log.info("===== ğŸ§© Routing ê²°ê³¼ =====");
            log.info("ğŸ“Œ Meal: {}", meal.isBlank() ? "(ì—†ìŒ)" : meal);
            log.info("ğŸ‹ Exercise: {}", exercise.isBlank() ? "(ì—†ìŒ)" : exercise);
            log.info("ğŸ’¬ Emotion: {}", emotion.isBlank() ? "(ì—†ìŒ)" : emotion);
            log.info("============================\n");

            return new RoutingResult(meal, exercise, emotion);

        } catch (Exception e) {
            log.error("âŒ Routing JSON íŒŒì‹± ì‹¤íŒ¨: {}", e.getMessage());
            log.error("âš ï¸ ì›ë¬¸ Routing ì‘ë‹µ: {}", response);

            return new RoutingResult("", "", "");
        }
    }


    // ======================================================================
    // ğŸ”¥ ì‚­ì œ ëª…ë ¹ ê°ì§€ â€” ì „ì²´ ì‚­ì œ
    // ======================================================================
    private boolean isDeleteAllCommand(String text) {
        if (text == null) return false;

        String lower = text.toLowerCase();

        // ê°œë³„ ì‚­ì œ ì˜ë„(ìš´ë™/ì‹ë‹¨/ê°ì •) í¬í•¨í•˜ë©´ ì „ì²´ ì‚­ì œ ì•„ë‹˜
        if (lower.contains("ìš´ë™") || lower.contains("ì‹ë‹¨") || lower.contains("ê°ì •"))
            return false;

        String[] phrases = {
                "ì˜¤ëŠ˜ ê¸°ë¡ ì „ì²´ ì‚­ì œ",
                "ì˜¤ëŠ˜ ê¸°ë¡ ë‹¤ ì‚­ì œ",
                "ì˜¤ëŠ˜ ê¸°ë¡ ì „ë¶€ ì‚­ì œ",
                "ì˜¤ëŠ˜ ì „ì²´ ì‚­ì œ",
                "ê¸°ë¡ ì „ì²´ ì‚­ì œ",
                "ê¸°ë¡ ì „ë¶€ ì‚­ì œ",
                "ì „ì²´ ê¸°ë¡ ì‚­ì œ",
                "ì „ë¶€ ë‹¤ ì§€ì›Œ",
                "ëª¨ë“  ê¸°ë¡ ì‚­ì œ",
                "ì „ì²´ ì´ˆê¸°í™”",
                "ê¸°ë¡ ì´ˆê¸°í™”",
                "ê¸°ë¡ ë‹¤ ì§€ì›Œ",
                "ê¸°ë¡ ì‹¹ ì§€ì›Œ",
                "ì˜¤ëŠ˜ ê¸°ë¡ ì´ˆê¸°í™”"
        };

        for (String p : phrases) {
            if (lower.contains(p)) return true;
        }

        return false;
    }


    // ======================================================================
    // ğŸ± ì‹ë‹¨ ì‚­ì œ ëª…ë ¹ ê°ì§€
    // ======================================================================
    private boolean isDeleteMealCommand(String text) {
        if (text == null) return false;
        String t = text.toLowerCase();

        String[] phrases = {
                "ì‹ë‹¨ ì‚­ì œ", "ì‹ë‹¨ ì´ˆê¸°í™”", "ì‹ë‹¨ ì „ë¶€ ì‚­ì œ",
                "ì‹ë‹¨ ë‹¤ ì§€ì›Œ", "ì˜¤ëŠ˜ ì‹ë‹¨ ì‚­ì œ",
                "ë¨¹ì€ê±° ì‚­ì œ", "ë¨¹ì€ ê±° ë‹¤ ì§€ì›Œ",
                "ì˜¤ëŠ˜ ì‹ë‹¨ ì´ˆê¸°í™”", "ì˜¤ëŠ˜ ë¨¹ì€ê±° ë¦¬ì…‹"
        };

        for (String p : phrases) if (t.contains(p)) return true;

        return false;
    }


    // ======================================================================
    // ğŸ‹ ìš´ë™ ì‚­ì œ ëª…ë ¹ ê°ì§€
    // ======================================================================
    private boolean isDeleteExerciseCommand(String text) {
        if (text == null) return false;
        String t = text.toLowerCase();

        String[] phrases = {
                "ìš´ë™ ì‚­ì œ", "ìš´ë™ ê¸°ë¡ ì‚­ì œ", "ìš´ë™ ì´ˆê¸°í™”",
                "ìš´ë™ ë‹¤ ì§€ì›Œ", "ì˜¤ëŠ˜ ìš´ë™ ì‚­ì œ",
                "ìš´ë™ ì „ë¶€ ì‚­ì œ", "ìš´ë™ ë¦¬ì…‹", "ì˜¤ëŠ˜ ìš´ë™ ë‹¤ ì§€ì›Œ"
        };

        for (String p : phrases) if (t.contains(p)) return true;

        return false;
    }


    // ======================================================================
    // ğŸ’¬ ê°ì • ì‚­ì œ ëª…ë ¹ ê°ì§€
    // ======================================================================
    private boolean isDeleteEmotionCommand(String text) {
        if (text == null) return false;
        String t = text.toLowerCase();

        String[] phrases = {
                "ê°ì • ì‚­ì œ", "ê°ì • ê¸°ë¡ ì‚­ì œ", "ê°ì • ì´ˆê¸°í™”",
                "ê¸°ë¶„ ê¸°ë¡ ì‚­ì œ", "ê°ì • ë‹¤ ì§€ì›Œ",
                "ì˜¤ëŠ˜ ê°ì • ì‚­ì œ", "ê°ì • ì „ë¶€ ì‚­ì œ"
        };

        for (String p : phrases) if (t.contains(p)) return true;

        return false;
    }


    /**
     * ğŸ”¥ ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ â€” ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
     */
    private String buildPrompt(String text) {
        return """
ë„ˆëŠ” í•œêµ­ì–´ ê±´ê°• ì¼ê¸° ë¬¸ì¥ì„ [ì‹ë‹¨], [ìš´ë™], [ê°ì •] ì„¸ ê°€ì§€ë¡œ ì •í™•í•˜ê²Œ ë¶„ë¥˜í•˜ëŠ” AI ë¼ìš°í„°ë‹¤.

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ë§Œ ë°˜í™˜í•´ì•¼ í•œë‹¤:
{
  "mealText": "",
  "exerciseText": "",
  "emotionText": ""
}

------------------------------------------------------------
ğŸ”¥ [ì „ì²´ ê¸°ë¡ ì‚­ì œ ëª…ë ¹ â€” ì„¸ í•­ëª©ì„ ëª¨ë‘ ì±„ì›€]
ë‹¤ìŒ í‘œí˜„ì´ í¬í•¨ë˜ë©´ mealText / exerciseText / emotionText ì „ë¶€ ë™ì¼í•˜ê²Œ ì±„ìš´ë‹¤:

- ëª¨ë“  ê¸°ë¡ ì‚­ì œ
- ì „ì²´ ê¸°ë¡ ì‚­ì œ
- ì˜¤ëŠ˜ ê¸°ë¡ ë‹¤ ì§€ì›Œ
- ì „ë¶€ ì‚­ì œ
- ì „ë¶€ ì§€ì›Œ
- ì „ì²´ ë¦¬ì…‹
- ê¸°ë¡ ì´ˆê¸°í™”
- ê¸°ë¡ ì „ë¶€ ì‚­ì œ
- ì˜¤ëŠ˜ ê¸°ë¡ ì´ˆê¸°í™”

ì´ ê²½ìš° ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•íƒœë¡œ ì¶œë ¥í•œë‹¤:

{
  "mealText": "ì „ì²´ ê¸°ë¡ ì‚­ì œ",
  "exerciseText": "ì „ì²´ ê¸°ë¡ ì‚­ì œ",
  "emotionText": "ì „ì²´ ê¸°ë¡ ì‚­ì œ"
}

------------------------------------------------------------
ğŸ¯ í•µì‹¬ ë¶„ë¥˜ ê·œì¹™
- ìŒì‹/ì‹ì‚¬/ì„­ì·¨ ê´€ë ¨ â†’ mealText
- ìš´ë™/í™œë™/ì‹ ì²´ ì›€ì§ì„ â†’ exerciseText
- ê°ì •/ê¸°ë¶„/ì‹¬ë¦¬ â†’ emotionText

------------------------------------------------------------
ğŸŸ¥ ë¬´ì‹œí•´ì•¼ í•  ë©”íƒ€ í‘œí˜„
("ê¸°ë¡í• ê²Œ", "ì •ë¦¬í•´ì¤˜", "í• ê±°ì•¼", "ì¢€", "ì¡°ê¸ˆ" ë“± ì˜ë¯¸ ì—†ëŠ” í‘œí˜„)

------------------------------------------------------------
ğŸŸ¦ ìš´ë™ ë¬¸ì¥ ê°•í™” ê·œì¹™
ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ ë°˜ë“œì‹œ exerciseTextë¡œ ë³´ë‚¸ë‹¤:

1) ìš´ë™ ì´ë¦„/ìœ ì‚°ì†Œ/ê·¼ë ¥
(í‘¸ì‹œì—…, ìŠ¤ì¿¼íŠ¸, í„±ê±¸ì´, ëŸ°ë‹, ì¡°ê¹…, ìì „ê±°, ì›¨ì´íŠ¸ ë“±)

2) ìš´ë™ í‚¤ì›Œë“œ
"ìš´ë™", "í™œë™ëŸ‰", "ì†Œëª¨ì¹¼ë¡œë¦¬", "ìš´ë™ëŸ‰"

3) ìš´ë™ ì‚­ì œ/ì´ˆê¸°í™” ëª…ë ¹
- ìš´ë™ ì „ë¶€ ì§€ì›Œì¤˜
- ìš´ë™ ê¸°ë¡ ì‚­ì œ
- ìš´ë™ ì‹¹ ì—†ì• 
- ìš´ë™ ë¦¬ì…‹
- ìš´ë™ ì „ì²´ ì‚­ì œ
- ìš´ë™ ë‹¤ ì§€ì›Œ
- ìš´ë™ ë‚´ìš© ì´ˆê¸°í™”

------------------------------------------------------------
ğŸŸ© ì‹ë‹¨ ë¬¸ì¥ ê°•í™” ê·œì¹™
ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ mealTextë¡œ ë³´ë‚¸ë‹¤:

1) ìŒì‹ëª…/ì‹ì‚¬ëª…
(ì•„ì¹¨, ì ì‹¬, ì €ë…, ê°„ì‹, ê¹€ë°¥, ë°¥, ë¼ë©´ ë“±)

2) ì‹ë‹¨ ì‚­ì œ/ë¦¬ì…‹ ëª…ë ¹
- ì‹ë‹¨ ì „ë¶€ ì§€ì›Œì¤˜
- ì‹ì‚¬ ê¸°ë¡ ì‚­ì œ
- ë¨¹ì€ê±° ë‹¤ ì§€ì›Œ
- ì˜¤ëŠ˜ ë¨¹ì€ ê²ƒ ë¦¬ì…‹

------------------------------------------------------------
ğŸ’› ê°ì • ë¬¸ì¥ ê°•í™” ê·œì¹™
ê°ì • ë‹¨ì–´ê°€ ìˆìœ¼ë©´ emotionText  
ë˜ëŠ” ì•„ë˜ ëª…ë ¹ì´ ìˆìœ¼ë©´ emotionText:

- ê°ì • ê¸°ë¡ ì‚­ì œ
- ê¸°ë¶„ ê¸°ë¡ ì§€ì›Œì¤˜
- ê°ì • ë°ì´í„° ë¦¬ì…‹
- ê°ì • ì „ë¶€ ì—†ì• 
- ì˜¤ëŠ˜ ê°ì • ì‚­ì œ

------------------------------------------------------------
ğŸ§© [ì§§ì€ ë¬¸ì¥ ìë™ í™•ì¥ ê·œì¹™ â€” ë§¤ìš° ì¤‘ìš”]

ì…ë ¥ ë¬¸ì¥ì´ ë„ˆë¬´ ì§§ê±°ë‚˜ ë‹¨ì–´ë§Œ ìˆëŠ” ê²½ìš°(ì˜ˆ: â€œìœ ì‚°ì†Œ 1ì‹œê°„â€, â€œí‘¸ì‹œì—… 20ê°œâ€, â€œë¼ë©´ 2ê°œâ€, â€œìš°ìš¸í•¨â€)  
AIê°€ ë°˜ë“œì‹œ ì˜ë¯¸ê°€ ëª…í™•í•œ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ í™•ì¥í•´ì•¼ í•œë‹¤.

[ìš´ë™ í™•ì¥ ì˜ˆì‹œ]
- "ì¡°ê¹… 30ë¶„" â†’ "ì˜¤ëŠ˜ ìš´ë™ìœ¼ë¡œ ì¡°ê¹… 30ë¶„ í–ˆì–´"
- "ìœ ì‚°ì†Œ 1ì‹œê°„ ë”" â†’ "ì˜¤ëŠ˜ ê¸°ì¡´ ìš´ë™ì— ì¶”ê°€ë¡œ ìœ ì‚°ì†Œ 1ì‹œê°„ ë” í–ˆì–´"
- "í‘¸ì‹œì—… 20ê°œ" â†’ "ì˜¤ëŠ˜ ìš´ë™ìœ¼ë¡œ í‘¸ì‹œì—… 20ê°œ í–ˆì–´"

[ì‹ë‹¨ í™•ì¥ ì˜ˆì‹œ]
- "ë°¥ ë‘ê³µê¸°" â†’ "ì˜¤ëŠ˜ ë°¥ ë‘ ê³µê¸° ë¨¹ì—ˆì–´"
- "ë¼ë©´ 2ê°œ" â†’ "ì˜¤ëŠ˜ ë¼ë©´ 2ê°œ ë¨¹ì—ˆì–´"
- "ì €ë… ì¹˜í‚¨" â†’ "ì €ë…ìœ¼ë¡œ ì¹˜í‚¨ ë¨¹ì—ˆì–´"

[ê°ì • í™•ì¥ ì˜ˆì‹œ]
- "ìš°ìš¸í•¨" â†’ "ì˜¤ëŠ˜ ê¸°ë¶„ì´ ìš°ìš¸í–ˆì–´"
- "ì§œì¦" â†’ "ì˜¤ëŠ˜ ì§œì¦ë‚˜ëŠ” ê¸°ë¶„ì´ ë“¤ì—ˆì–´"
- "í–‰ë³µ" â†’ "ì˜¤ëŠ˜ ê¸°ë¶„ì´ í–‰ë³µí–ˆì–´"

âš  í™•ì¥ í›„ì— ë¶„ë¥˜í•´ì•¼ í•œë‹¤.
âš  í™•ì¥ëœ ë¬¸ì¥ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ ìì—°ì–´ ë¬¸ì¥ í˜•íƒœì´ì–´ì•¼ í•œë‹¤.

------------------------------------------------------------
ğŸ“Œ ë°˜í™˜ ê·œì¹™
- JSONë§Œ ë°˜í™˜
- ë¹ˆ ê°’ì€ "" (null ê¸ˆì§€)
- ì„¤ëª…/ì½”ë“œë¸”ë¡/ì¶”ê°€ í…ìŠ¤íŠ¸ ì ˆëŒ€ ê¸ˆì§€

ğŸ“¥ ì…ë ¥ ë¬¸ì¥:
"%s"
""".formatted(text);
    }

    /**
     * GPT ì‘ë‹µì—ì„œ JSONë§Œ ì¶”ì¶œ
     */
    private String extractJson(String text) {
        if (text == null) return "{}";
        int s = text.indexOf("{");
        int e = text.lastIndexOf("}");
        if (s >= 0 && e > s) return text.substring(s, e + 1);
        return "{}";
    }
}
